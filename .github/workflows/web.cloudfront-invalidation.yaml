name: Web Cache Invalidation (AWS CloudFront)


on:
  workflow_call:
    inputs:
      aws_github_oidc_audience:
        type: string
        required: false
        default: sts.amazonaws.com
        description: "(Optional) The OIDC audience to be specified when the JWT is created. Defaults to `sts.amazonaws.com`. This will work for most cases. Changing the default audience may be necessary when using non-default AWS partitions, such as China regions."
      aws_github_oidc_session_name:
        type: string
        required: false
        description: "(Optional) The identifier for the assumed role session via GitHub OIDC. Defaults to `GitHubActions`."
      aws_cloudfront_distribution_id:
        type: string
        required: true
        description: "(Required) The ID of the AWS CloudFront distribution to invalidate cache for. For example, `E1234567890ABC`."
      aws_cloudfront_invalidation_paths:
        type: string
        required: false
        default: "/*"
        description: "(Optional) Comma-separated list of paths to invalidate in the CloudFront distribution cache. Defaults to `/*`, which invalidates the entire cache. You can specify specific paths like `/index.html,/about.html`."
      aws_cloudfront_invalidation_wait:
        type: boolean
        required: false
        default: true
        description: "(Optional) Whether to wait for the invalidation to complete. Defaults to `true`. If set to `false`, the action will not wait for the invalidation to complete and will exit immediately after creating the invalidation request."

    secrets:
      aws_access_key_id:
        required: false
        description: "(Optional) The access key ID used to authenticate to the AWS account."
      aws_secret_access_key:
        required: false
        description: "(Optional) The secret access key used to authenticate to the AWS account."
      aws_github_oidc_iam_role:
        required: false
        description: "(Optional) The ARN (Amazon Resource Name) of the IAM role to assume via GitHub OIDC to authenticate to the AWS account."
      token:
        required: false
        description: "(Optional) The GitHub API token to use when communicating with GitHub API."

    outputs:
      aws_cloudfront_invalidation_id:
        value: ${{ jobs.invalidate.outputs.invalidation_id }}
        description: "The ID of the CloudFront invalidation that was created."
      aws_cloudfront_invalidation_paths:
        value: ${{ jobs.invalidate.outputs.invalidation_paths }}
        description: "The paths that were invalidated in the CloudFront distribution."
      aws_cloudfront_distribution_id:
        value: ${{ jobs.invalidate.outputs.distribution_id }}
        description: "The ID of the CloudFront distribution that was invalidated."

jobs:
  invalidate:
    name: Invalidate CloudFront Cache
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Configure AWS Credentials
      id: configure-aws-credentials
      uses: aws-actions/configure-aws-credentials@v5
      with:
        aws-region: us-east-1
        aws-access-key-id: ${{ secrets.aws_access_key_id }}
        aws-secret-access-key: ${{ secrets.aws_secret_access_key }}
        role-to-assume: ${{ secrets.aws_github_oidc_iam_role }}
        role-session-name: ${{ inputs.aws_github_oidc_session_name }}
        audience: ${{ inputs.aws_github_oidc_audience }}
        mask-aws-account-id: true

    - name: Invalidate CloudFront Cache
      id: invalidate-cache
      run: |
        input="${{ inputs.aws_cloudfront_invalidation_paths }}"

        input_paths=$(echo "$input" | sed 's/[[:space:]]*,[[:space:]]*/ /g' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

        INVALIDATION_ID=$(aws cloudfront create-invalidation \
          --distribution-id ${{ inputs.aws_cloudfront_distribution_id }} \
          --paths "$input_paths" \
          --query 'Invalidation.Id' \
          --output text)

        echo "Created invalidation: $INVALIDATION_ID"
        echo "invalidation-id=$INVALIDATION_ID" >> $GITHUB_OUTPUT
        echo "invalidation-paths=$input_paths" >> $GITHUB_OUTPUT
        echo "distribution-id=${{ inputs.aws_cloudfront_distribution_id }}" >> $GITHUB_OUTPUT

        if [ "${{ inputs.aws_cloudfront_invalidation_wait }}" = "true" ]; then
          echo "Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id ${{ inputs.aws_cloudfront_distribution_id }} \
            --id "$INVALIDATION_ID"
          echo "Invalidation completed successfully"
        else
          echo "Skipping wait for invalidation completion (aws_cloudfront_invalidation_wait=false)"
        fi

    outputs:
      invalidation_id: ${{ steps.invalidate-cache.outputs.invalidation-id }}
      invalidation_paths: ${{ steps.invalidate-cache.outputs.invalidation-paths }}
      distribution_id: ${{ steps.invalidate-cache.outputs.distribution-id }}
